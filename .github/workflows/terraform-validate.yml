name: Terraform Validate

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'environment/**/*.tf'
      - 'modules/**/*.tf'
      - '.github/workflows/terraform-*.yml'
  push:
    branches:
      - terraform-version-update

jobs:
  validate-dev:
    runs-on: ubuntu-latest
    name: Validate Dev Environment

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init (Dev)
        working-directory: environment/dev
        run: terraform init -backend=false

      - name: Terraform Validate (Dev)
        working-directory: environment/dev
        run: terraform validate

      - name: Check Terraform Version
        working-directory: environment/dev
        run: |
          echo "Required Terraform version:"
          grep 'required_version' versions.tf || echo "No version constraint found"

  validate-prod:
    runs-on: ubuntu-latest
    name: Validate Prod Environment

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (Prod)
        working-directory: environment/prod
        run: terraform init -backend=false

      - name: Terraform Validate (Prod)
        working-directory: environment/prod
        run: terraform validate

      - name: Check Terraform Version
        working-directory: environment/prod
        run: |
          echo "Required Terraform version:"
          grep 'required_version' versions.tf || echo "No version constraint found"

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true

  summary:
    runs-on: ubuntu-latest
    needs: [validate-dev, validate-prod, security-scan]
    if: always()

    steps:
      - name: Validation Summary
        run: |
          echo "## Terraform Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Dev Environment: ${{ needs.validate-dev.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Prod Environment: ${{ needs.validate-prod.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
